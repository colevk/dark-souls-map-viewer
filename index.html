<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dark Souls Map Viewer</title>
  <link href="css/reset.css" rel="stylesheet" type="text/css">
  <link href="css/foundation.min.css" rel="stylesheet" type="text/css">
  <style>
  input {
    margin-bottom: 0.2rem !important;
  }
  button {
    margin-bottom: 0rem !important;
  }
  </style>

  <script src="js/lib/jquery-2.1.1.min.js"></script>
  <script src="js/lib/three.js"></script>

  <script src="js/BigShader.js"></script>
  <script src="js/Interface.js"></script>
  <script src="js/Controls.js"></script>
  <script src="js/SceneLoader.js"></script>
  <script src="js/Config.js"></script>
</head>

<body style="overflow:hidden;">
  <div id="sidebar" class="panel" style="height: 100vh; width: 25rem; float: right; overflow: auto">
    <h4>Dark Souls Map Viewer</h4>
    <hr>
    <label>
      W, A, S, D, Q, E &mdash; Move<br>
      Shift &mdash; Speed up<br>
      Mouse &mdash; Look<br>
    </label>
    <hr>
    <label><input id="normalShading" type="checkbox" onchange="interface.toggleNormalShading()"> Show normals</label>
    <label><input id="edgeHighlight" type="checkbox" onchange="interface.toggleEdgeHighlighting()"> Highlight edges</label>
    <label><input id="backfaceCulling" type="checkbox" onchange="interface.toggleBackfaceCulling()"> Cull backfaces</label>
    <label><input id="wrapAround" type="checkbox" onchange="interface.toggleWrapAround()"> Wrap-around lighting</label>
    <label><input type="color" value="#000000" onchange="interface.setEdgeColor(this.value)"> Edge color</label>
    <label><input type="color" value="#ffffff" onchange="interface.setLightColor(this.value)"> Light color</label>
    <button class="button tiny" onclick="interface.resetCamera()">Reset camera position</button>
    <hr>
    <select onchange="interface.swapGames(this.value)">
      <option value="ds1">Dark Souls 1</option>
      <option value="ds2">Dark Souls 2</option>
    </select>
    <div id="ds1" class="file-list"></div>
    <div id="ds2" class="file-list"></div>
  </div>
  <div id="canvas" style="height: 100%; margin-right: 25rem;"></div>

  <script>
  var sidebar, canvas, renderer, clock, scene, camera, controls, material,
      meshes, interface;

  function init() {
    sidebar = $('#sidebar');
    canvas = $('#canvas');

    renderer = new THREE.WebGLRenderer();
    renderer.setSize( canvas.width(), canvas.height() );
    canvas.append(renderer.domElement);

    clock = new THREE.Clock();
    scene = new THREE.Scene();
    material = BigShaderMaterial;

    camera = new THREE.PerspectiveCamera( 75, canvas.width() / canvas.height(), 0.1, 10000 );

    var havePointerLock = 'pointerLockElement' in document ||
                          'mozPointerLockElement' in document ||
                          'webkitPointerLockElement' in document;

    if (havePointerLock) {
      controls = new PointerLockControls(camera, renderer.domElement);

      var element = canvas.get()[0];

			var pointerlockchange = function ( event ) {
				if ( document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element ) {
					controls.enabled = true;
				} else {
					controls.enabled = false;
				}
			}

			// Hook pointer lock state change events
			document.addEventListener( 'pointerlockchange', pointerlockchange, false );
			document.addEventListener( 'mozpointerlockchange', pointerlockchange, false );
			document.addEventListener( 'webkitpointerlockchange', pointerlockchange, false );

			canvas.click(function ( event ) {
				element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;
				element.requestPointerLock();
			});
    } else {
      controls = new NoPointerLockControls(camera, renderer.domElement);
    }

    camera.position = Config.defaultCameraPosition();
    camera.lookAt(Config.defaultCameraLookAt());

    meshes = [];

    for (var i = 0; i < Config.ds1.length; i++) {
      function loadFunc(bufferGeometry, fileNumber) {
        var mesh = new THREE.Mesh(bufferGeometry, BigShaderMaterial);
        mesh.game = 'ds1';
        mesh.fileNumber = fileNumber;
        meshes.push(mesh);

        if (Config.ds1State[fileNumber]) { scene.add(mesh); }
      };

      SceneLoader.loadIVFile('data/ds1/' + Config.ds1[i] + '.iv', i, loadFunc);
    }

    for (var i = 0; i < Config.ds2.length; i++) {
      var loadFunc = function (bufferGeometry, fileNumber) {
        var mesh = new THREE.Mesh(bufferGeometry, BigShaderMaterial);
        mesh.game = 'ds2';
        mesh.fileNumber = fileNumber;
        meshes.push(mesh);
      };

      SceneLoader.loadIVFile('data/ds2/' + Config.ds2[i] + '.iv', i, loadFunc);
    }

    scene.add(Config.light);

    interface = new Interface(scene, camera, meshes, material, Config);
  }

  var render = function() {
    requestAnimationFrame(render);

    controls.update(clock.getDelta());
    renderer.render(scene, camera);
  };

  $(window).resize(function () {
    renderer.setSize(canvas.width(), canvas.height());
    camera.aspect = canvas.width() / canvas.height();
    camera.updateProjectionMatrix();
  })

  init();
  interface.setupInterface();
  render();
  </script>
</body>
</html>
