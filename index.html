<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dark Souls Map Viewer</title>
  <link href="css/reset.css" rel="stylesheet" type="text/css">

  <script src="js/lib/jquery-2.1.1.min.js"></script>
  <script src="js/lib/three.js"></script>

  <script src="js/CustomFlyControls.js"></script>
  <script src="js/functions.js"></script>
  <script src="js/config.js"></script>
</head>

<body style="overflow:hidden;">
  <div id="sidebar" style="height: 100vh; width: 25rem; float: right; overflow: auto">
    <select>
      <option value="ds1">Dark Souls 1</option>
      <option value="ds2">Dark Souls 2</option>
    </select>
    <form id="ds1_container" onchange="ds1Change()"></form>
    <form id="ds2_container" onchange="ds2Change()"></form>
  </div>
  <div id="canvas" style="height: 100vh; margin-right: 25rem;"></div>
  <script id="lambert-vert" type="x-shader/x-vertex">
  attribute vec3 color;

  varying vec3 vNormal;
  varying vec3 vBC;

  void main() {
    vNormal = normal;
    vBC = color;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
  </script>

  <script id="lambert-frag" type="x-shader/x-fragment">
  #extension GL_OES_standard_derivatives : enable

  varying vec3 vNormal;
  varying vec3 vBC;

  float edgeFactor() {
    vec3 d = fwidth(vBC);
    vec3 a3 = smoothstep(vec3(0.0), d, vBC);
    return min(min(a3.x, a3.y), a3.z);
  }

  void main() {
    vec3 lambert = vec3(0.75 + 0.25 * dot(vNormal, normalize(vec3(1.0))));
    vec3 lineColor = vec3(0.0);

    gl_FragColor = vec4(mix(lineColor, lambert, edgeFactor()), 1.0);
  }
  </script>

  <script>
  var sidebar, canvas, renderer, clock, scene, camera, controls,
      ds1Meshes, ds1Enabled, ds2Meshes, ds2Enabled;

  function setupInterface() {
    $('#ds2_container').toggle();

    for (var i = 0; i < config.ds1.length; i++) {
      $('#ds1_container').append(
        $('<label><input type="checkbox" name="ds1" value="' + i + '" checked><span>' + config.ds1[i] + '</span><br></label>')
      );
    }
    for (var i = 0; i < config.ds2.length; i++) {
      $('#ds2_container').append(
        $('<label><input type="checkbox" name="ds2" value="' + i + '" checked><span>' + config.ds2[i] + '</span><br></label>')
      );
    }
  }
  setupInterface();

  function swapGames() {
    $('#ds1_container').toggle();
    $('#ds2_container').toggle();
  }

  function init() {
    sidebar = $('#sidebar');
    canvas = $('#canvas');

    ds1Enabled = Array.apply(null, new Array(config.ds1.length)).map(Boolean.prototype.valueOf, true);
    ds2Enabled = Array.apply(null, new Array(config.ds2.length)).map(Boolean.prototype.valueOf, true);

    renderer = new THREE.WebGLRenderer();
    renderer.setSize( canvas.width(), canvas.height() );
    canvas.append(renderer.domElement);

    clock = new THREE.Clock();
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera( 75, canvas.width() / canvas.height(), 0.1, 10000 );
    camera.rotation.order = "YZX";

    controls = new THREE.CustomFlyControls(camera, renderer.domElement);
    controls.movementSpeed = 20;
    controls.rollSpeed = 2;
    controls.dragToLook = true;

    var material = new THREE.ShaderMaterial({
      vertexShader: $('#lambert-vert').text(),
      fragmentShader: $('#lambert-frag').text()
    });

    ds1Meshes = [];

    for (var i = 0; i < config.ds1.length; i++) {
      var loadFunc = function (bufferGeometry) {
        var mesh = new THREE.Mesh(bufferGeometry, material);
        scene.add(mesh);
      };

      loadIVFile('data/ds1/' + config.ds1[i] + '.iv', loadFunc);
    }
  }

  var render = function() {
    requestAnimationFrame(render);

    controls.update(clock.getDelta());
    renderer.render(scene, camera);
  };

  init();
  render();
  </script>
</body>
</html>
